---
layout: post
title: Assignment - Blog Post 1
---

> This blog post includes 

## §1. Database Creation

### Step 1: Data Importing

For the temperature dataset, first do the visualization. The real importing part happens together with the database creation.

```python
import pandas as pd
temperatures = pd.read_csv("/Users/xuyan/Desktop/temps.csv")
temperatures.head()
```

Now, import the stations and the countries dataset

```python
# this is the countries data
countries_url = "https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv"
countries = pd.read_csv(countries_url)
# countries.head()
```

```python
# this is the stations data
stations_url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(stations_url)
# stations.head()
```

### Step 2: Database Settling

First, create the database:

```python
import sqlite3
conn = sqlite3.connect("temps.db")
# store the path for temperature csv file
temps = "/Users/xuyan/Desktop/temps.csv"
df_iter = pd.read_csv(temps, chunksize = 100000)
df = df_iter.__next__()
```

Now, reshape the dataset to store as the temperature dataset

```python
# reshape function:
def prepare_df(df):
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100
    return(df)

# reshaping process:
df = prepare_df(df)
df.head()
```

Now, write the three datasets to the database:

```python
# 1. write temperature dataset to database
df_iter = pd.read_csv(temps, chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False)

# 2. write stations dataset to database
stations.to_sql("stations", conn, if_exists = "replace", index = False)

# 3. write countries dataset to database
countries.to_sql("countries", conn, if_exists = "replace", index = False)
```

### Step 3: Database Precheck

Now, visualize the general information of the dataset:

- Datasets in Database

```python
cursor = conn.cursor()
cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
print(cursor.fetchall())
```
`[('temperatures',), ('stations',), ('countries',)]`


- Datasets Contents in Database

```python
cursor.execute("SELECT sql FROM sqlite_master WHERE type='table';")

for result in cursor.fetchall():
    print(result[0])
```
`CREATE TABLE "temperatures" (
"ID" TEXT,
  "Year" INTEGER,
  "Month" INTEGER,
  "Temp" REAL
)
CREATE TABLE "stations" (
"ID" TEXT,
  "LATITUDE" REAL,
  "LONGITUDE" REAL,
  "STNELEV" REAL,
  "NAME" TEXT
)
CREATE TABLE "countries" (
"FIPS 10-4" TEXT,
  "ISO 3166" TEXT,
  "Name" TEXT
)`

## §2. Query Function

> This Query function `query_climate_database()` inputs specified country name, start year and end year for consideration, specified month to look on, and return a dataset to write on. 

- Function Input - Dataset Restriction Contents:
	- `country`, a string giving the name of a country for which data should be returned.
	- `year_begin` and `year_end`, two integers giving the earliest and latest years for which should be returned.
	- `month`, an integer giving the month of the year for which should be returned.

- Output Dataset Contents:
	- The station name.
	- The latitude of the station.
	- The longitude of the station.
	- The name of the country in which the station is located.
	- The year in which the reading was taken.
	- The month in which the reading was taken.
	- The average temperature at the specified station during the specified year and month.

### Step 1: Function Construction:

Now, start writing the function:

```python
def query_climate_database(country, year_begin, year_end, month):
    
    """
    function returning a dataset of temperature readings for
    the specified country, in the specified date range, in
    the specified month of the year.
    
    Input
    --------
    country: string, tell which country for database to return
    year_begin: int, earliest year to be returned
    year_end: int, last year to be returned
    month: int, month of the year to be returned
    
    Output
    --------
    out: dataframe of temperature readings for the specified
        country, in the specified date range, in the specified
        month of the year.
    """
    
    # Write SQL command to satisfy with the output type
    # SELECT: necessay column names
    # From & LEFT JOIN * 2: "merge" the three datasets in form of temperature dataset
    # WHERE: specified output places
    cmd = \
    f"""
    SELECT S.name, S.latitude, S.longitude, C.Name, T.year, T.month, T.temp
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON SUBSTRING(T.id, 1, 2) = C.`FIPS 10-4`
    WHERE C.name="{country}" AND T.month={month} AND T.year>={year_begin} AND T.year<={year_end} 
    """
    
    # Write dataset from SQL Query
    out = pd.read_sql_query(cmd, conn)
    
    return out
```

- A NOTE from self-learning of SQL: For the second left join command, can be done via either `=` or `LIKE`. However, `LIKE` seemed to be slower compared to the direct comparison with the `SUBSTRING` command via `=`.

### Step 2: Function Check

Check that the function output aligns with the example output:

```python
query_climate_database(country = "India", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Country</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1981</td>
      <td>1</td>
      <td>24.57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1982</td>
      <td>1</td>
      <td>24.19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>23.51</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1984</td>
      <td>1</td>
      <td>24.81</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7965</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>5.10</td>
    </tr>
    <tr>
      <th>7966</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1986</td>
      <td>1</td>
      <td>6.90</td>
    </tr>
    <tr>
      <th>7967</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1994</td>
      <td>1</td>
      <td>8.10</td>
    </tr>
    <tr>
      <th>7968</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1995</td>
      <td>1</td>
      <td>5.60</td>
    </tr>
    <tr>
      <th>7969</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1997</td>
      <td>1</td>
      <td>5.70</td>
    </tr>
  </tbody>
</table>
<p>7970 rows × 7 columns</p>
</div>

Now, get an almost similar dataset as the example one. However, its dimension is (7970, 7) instead of (3152, 7). I'm really confused right here. Any comments and suggestions would helps a lot. Thank you! :)

## §3. Geographical Scatter Function

> This function `temperature_coefficient_plot()` accept five explicit arguments, and an undetermined number of keyword arguments; and output an interactive geographic scatterplot, with a point for each station, such that the color of the point reflects an estimate of the yearly change in temperature during the specified month and time period at that station.

- Function Input - Dataset Restriction Contents:
	- `country`, a string giving the name of a country for which data should be returned.
	- `year_begin` and `year_end`, two integers giving the earliest and latest years for which should be returned.
	- `month`, an integer giving the month of the year for which should be returned.
	- `min_obs`, the minimum required number of years of data for any given station. Only data for stations with at least min_obs years worth of data in the specified month should be plotted; the others should be filtered out. df.transform() plus filtering is a good way to achieve this task.
	- `**kwargs`, additional keyword arguments passed to px.scatter_mapbox(). These can be used to control the colormap used, the mapbox style, etc.

- Output Contents:
	- an interactive geographic scatterplot constructed using Plotly Express as described in `INTRO` part.

### Step 1: Function Construction

First, import necessary packages:

```python
from sklearn.linear_model import LinearRegression
from plotly import express as px
from matplotlib import pyplot as plt
```

As illustrated in the lecture, there's a coefficient funciton for use in the plotting function:

```python
def coef(data_group):
    x = data_group[["Year"]] # 2 brackets because X should be a df
    y = data_group["Temp"]   # 1 bracket because y should be a series
    LR = LinearRegression()
    LR.fit(x, y)
    return LR.coef_[0]
```

Now, start writing the plotting-return function:

```python

```

### Step 2: Sample Output Check

```python
color_map = px.colors.diverging.RdGy_r # choose a colormap
fig = temperature_coefficient_plot("India", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_scale=color_map)
fig.show()
```

## §4. More Figures #1:



## §5. More Figures #2:



## §6. Close Database

Last, close the database.

```python
conn.close()
```

This is the end of this blog post! :)

{::options parse_block_html="true" /}
<div class="got-help">
I learned something really cool from my peer feedback! 
</div>
{::options parse_block_html="false" /}

{::options parse_block_html="true" /}
<div class="gave-help">
I gave one of my peers a cool suggestion! 
</div>
{::options parse_block_html="false" /}

